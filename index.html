<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown & LaTeX Renderer (KaTeX)</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
            color: #333;
            line-height: 1.6;
        }
        .container {
            max-width: 900px;
            margin: 20px auto;
            padding: 25px;
            background-color: #fff;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            border-radius: 8px;
        }
        h1, h2 {
            color: #333;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        label {
            display: block;
            margin-top: 15px;
            margin-bottom: 5px;
            font-weight: bold;
        }
        textarea {
            width: 100%;
            min-height: 200px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-family: monospace;
            font-size: 14px;
            margin-bottom: 15px;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
            transition: background-color 0.2s ease;
        }
        button:hover {
            background-color: #0056b3;
        }
        .info {
            font-size: 0.9em;
            color: #555;
            margin-top: 20px;
            padding: 10px;
            background-color: #e9ecef;
            border-left: 4px solid #007bff;
            border-radius: 4px;
        }
        .input-section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px dashed #ccc;
        }
        .input-section:last-child {
            border-bottom: none;
        }
    </style>
    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>Markdown & LaTeX Renderer (with KaTeX)</h1>

        <div class="input-section">
            <h2>Markdown Input</h2>
            <label for="markdownInput">Paste your Markdown (can include LaTeX for math):</label>
            <textarea id="markdownInput" placeholder="Type or paste Markdown here...
Example:
# Hello World
This is **bold** and *italic*. Underscores for emphasis: _test_

A list:
- Item 1
- Item 2

Math (KaTeX will render these):
Inline: $E = mc^2$ or \( \alpha + \beta \)
Display:
$$
\sum_{i=0}^{n} i = \frac{n(n+1)}{2}
$$
\[
\text{H}_2\text{O} \quad \text{or} \quad \text{H}_{2}\text{O} \quad \text{or H$_2$O}
\]
The mass of $\text{H}_2\text{SO}_4$ is important.
The final answer is $\boxed{107.875\%}$.
"></textarea>
            <button id="renderMarkdownBtn">Render Markdown</button>
        </div>

        <div class="info">
            <p><strong>How it works:</strong></p>
            <ul>
                <li><strong>Markdown Rendering:</strong> Uses Marked.js. LaTeX within Markdown is preserved using placeholders before Marked.js parsing, then reinserted.</li>
                <li><strong>LaTeX Math Rendering:</strong> Uses KaTeX in the new tab. It processes LaTeX math delimiters like <code>$...$</code>, <code>$$...$$</code>, <code>\(...\)</code>, and <code>\[...\]</code>.</li>
                <li>The rendered output will open in a new tab. Ensure your browser allows pop-ups for this site.</li>
            </ul>
        </div>
    </div>

    <script>
        // --- Configuration Constants ---
        const GITHUB_MARKDOWN_CSS_LINK = 'https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.8.1/github-markdown.min.css';
        const KATEX_CSS_LINK = 'https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css';
        const KATEX_JS_LINK = 'https://cdn.jsdelivr.net/npm/katex/dist/katex.min.js';
        const KATEX_AUTORENDER_JS_LINK = 'https://cdn.jsdelivr.net/npm/katex/dist/contrib/auto-render.min.js';

        const RENDERED_PAGE_BODY_STYLE = `
        <style>
            body.markdown-body {
                box-sizing: border-box;
                min-width: 200px;
                max-width: 980px;
                margin: 0 auto;
                padding: 45px;
            }
            @media (max-width: 767px) {
                body.markdown-body {
                    padding: 15px;
                }
            }
        </style>
        `;

        const KATEX_INIT_SCRIPT = `
        <script>
            function initKatexAutoRender() {
                if (typeof renderMathInElement === 'function') {
                    renderMathInElement(document.body, {
                        delimiters: [
                            {left: "$$", right: "$$", display: true},
                            {left: "\\\\[", right: "\\\\]", display: true},
                            {left: "$", right: "$", display: false, throwOnError: false},
                            {left: "\\\\(", right: "\\\\)", display: false}
                        ],
                        throwOnError: false // Don't halt rendering on a single bad expression
                    });
                } else {
                    console.error("KaTeX auto-render.min.js did not load or renderMathInElement is not defined. Retrying in 100ms.");
                    setTimeout(initKatexAutoRender, 100); // Retry if KaTeX hasn't loaded yet
                }
            }
            // Ensure KaTeX auto-render script calls initKatexAutoRender on load
        <\/script>
        `;

        // --- DOM Elements ---
        const markdownInputElement = document.getElementById('markdownInput');
        const renderButtonElement = document.getElementById('renderMarkdownBtn');

        // Configure Marked.js (globally for this script)
        marked.setOptions({
            gfm: true,      // Enable GitHub Flavored Markdown
            breaks: true,   // Treat newlines as <br>
            smartypants: false // Avoid smart quotes/dashes for better LaTeX compatibility
        });

        // --- Utility Functions ---
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); // $& means the whole matched string
        }

        // --- Core Logic Functions ---

        /**
         * Preprocesses Markdown text to protect KaTeX expressions before Markdown parsing.
         * It replaces LaTeX blocks with placeholders, parses Markdown, then restores LaTeX.
         * @param {string} markdownText - The raw Markdown text.
         * @returns {string} HTML string with KaTeX expressions preserved.
         */
        function preprocessMarkdownForKatex(markdownText) {
            const mathExpressions = [];
            let mathIndex = 0;
            let tempText = markdownText;

            // Helper to find math expressions and replace them with placeholders
            const addPlaceholder = (regex, type, originalOpen, originalClose) => {
                tempText = tempText.replace(regex, (match, content) => {
                    // Ensure content is not empty or just whitespace for some delimiters
                    // to avoid issues with marked.js and empty placeholders.
                    if (content.trim() === "") return match;

                    const placeholder = `%%${type}_MATH_PLACEHOLDER_${mathIndex}%%`;
                    mathExpressions.push({ placeholder, content, originalOpen, originalClose });
                    mathIndex++;
                    return placeholder;
                });
            };

            // Order matters: Process display math first, then inline.
            // Otherwise, inline regex might match parts of display math.
            addPlaceholder(/\$\$([\s\S]*?)\$\$/g, 'DISPLAY_SS', '$$', '$$');
            addPlaceholder(/\\\[([\s\S]*?)\\\]/g, 'DISPLAY_BRACKET', '\\[', '\\]');
            // For inline, ensure it's not just a single $ surrounded by spaces (common in currency)
            // This regex for inline $...$ is a bit more robust than just /$(.+?)$/g
            // It tries to avoid matching single dollar signs in text like "price is $5."
            // It looks for a non-space character after the first $ and before the last $.
            addPlaceholder(/\$([^\s$](?:[\s\S]*?[^\s$])?)\$/g, 'INLINE_S', '$', '$');
            addPlaceholder(/\\\(([\s\S]*?)\\\)/g, 'INLINE_PAREN', '\\(', '\\)');

            let html = marked.parse(tempText);

            // Restore KaTeX expressions, iterating backwards to handle nested placeholders correctly (if any)
            // and to avoid issues with string length changes during replacement.
            for (let i = mathExpressions.length - 1; i >= 0; i--) {
                const item = mathExpressions[i];
                const preservedKatexString = item.originalOpen + item.content + item.originalClose;
                // Use a global regex for replacement in case a placeholder appears multiple times (unlikely here but good practice)
                const placeholderRegex = new RegExp(escapeRegExp(item.placeholder), "g");
                html = html.replace(placeholderRegex, preservedKatexString);
            }
            return html;
        }

        /**
         * Opens a new browser tab and writes the provided HTML content into it.
         * @param {string} htmlContent - The HTML content to display in the new tab.
         * @param {string} [pageTitle="Rendered Output"] - The title for the new tab.
         */
        function openInNewTab(htmlContent, pageTitle = "Rendered Output") {
            const newTab = window.open('', '_blank');
            if (newTab) {
                newTab.document.open();
                newTab.document.write(`
                    <!DOCTYPE html>
                    <html lang="en">
                    <head>
                        <meta charset="UTF-8">
                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <title>${pageTitle}</title>
                        <link rel="stylesheet" href="${GITHUB_MARKDOWN_CSS_LINK}">
                        <link rel="stylesheet" href="${KATEX_CSS_LINK}">
                        ${RENDERED_PAGE_BODY_STYLE}
                        ${KATEX_INIT_SCRIPT}
                        <script defer src="${KATEX_JS_LINK}"><\/script>
                        <script defer src="${KATEX_AUTORENDER_JS_LINK}" onload="initKatexAutoRender()"><\/script>
                    </head>
                    <body class="markdown-body">
                        ${htmlContent}
                    </body>
                    </html>
                `);
                newTab.document.close();
            } else {
                alert("Failed to open new tab. Please check your pop-up blocker settings.");
            }
        }

        // --- Event Listeners ---
        renderButtonElement.addEventListener('click', () => {
            const markdownText = markdownInputElement.value;
            const htmlWithPreservedKatex = preprocessMarkdownForKatex(markdownText);
            openInNewTab(htmlWithPreservedKatex, "Rendered Markdown & LaTeX");
        });

    </script>
</body>
</html>
