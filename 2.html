<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Markdown & LaTeX Renderer</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">

  <!-- PAGE CORE STYLES -->
  <style>
    body {
      margin: 0;
      padding: 2rem;
      background: #f4f4f4;
      color: #333;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      line-height: 1.6;
    }
    .container {
      max-width: 900px;
      margin: auto;
      background: #fff;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
    }
    h1, h2 {
      border-bottom: 2px solid #eee;
      padding-bottom: 0.5rem;
    }
    .input-section {
      margin-bottom: 2rem;
    }
    .buttons {
      margin-bottom: 1rem;
    }
    .buttons button {
      background: #007bff;
      color: #fff;
      border: none;
      padding: 0.5rem 1rem;
      margin-right: 0.5rem;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .buttons button:hover {
      background: #0056b3;
    }
    textarea {
      width: 100%;
      min-height: 200px;
      padding: 1rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: monospace;
      font-size: 14px;
      box-sizing: border-box;
      margin-bottom: 1rem;
    }
    .info {
      background: #e9ecef;
      border-left: 4px solid #007bff;
      padding: 1rem;
      border-radius: 4px;
      font-size: 0.9rem;
    }
    .info ul {
      padding-left: 1.2rem;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Markdown & LaTeX Renderer</h1>
    <section class="input-section">
      <h2>Markdown Input</h2>
      <label for="markdownInput">Paste your Markdown (LaTeX allowed):</label>
      <textarea id="markdownInput" placeholder="
# Hello World
**Bold**, _italic_, and math:
Inline: $E=mc^2$
Display:
$$
\sum_{i=1}^n i = \tfrac{n(n+1)}2
$$
"></textarea>
      <div class="buttons">
        <button id="pasteBtn">Paste & Render</button>
        <button id="renderBtn">Render Markdown</button>
      </div>
    </section>
    <div class="info">
      <p><strong>How it works:</strong></p>
      <ul>
        <li>Markdown → HTML via Marked.js</li>
        <li>Math preserved and rendered by KaTeX</li>
        <li>Font-size, theme, raw/HTML toggle & save-as-image in new tab</li>
      </ul>
    </div>
  </div>

  <!-- MAIN LOGIC -->
  <script type="module">
    import { marked } from 'https://cdn.jsdelivr.net/npm/marked/marked.esm.js';

    // external CDN links for the new‐tab page
    const CDN = {
      gitMarkdownCss:   'https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.8.1/github-markdown.min.css',
      katexCss:         'https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css',
      katexJs:          'https://cdn.jsdelivr.net/npm/katex/dist/katex.min.js',
      katexAuto:        'https://cdn.jsdelivr.net/npm/katex/dist/contrib/auto-render.min.js',
      html2canvas:      'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js'
    };

    // font & theme keys
    const FONT_CFG = { key:'mdFontPct', basePx:16, stepPct:10, minPct:50, maxPct:300, defaultPct:100 };
    const THEME_KEY = 'mdTheme';

    document.addEventListener('DOMContentLoaded', () => {
      const mdInput  = document.getElementById('markdownInput');
      const pasteBtn = document.getElementById('pasteBtn');
      const renderBtn= document.getElementById('renderBtn');

      pasteBtn.addEventListener('click', async () => {
        if (!navigator.clipboard?.readText) {
          return alert('Clipboard API not supported');
        }
        try {
          mdInput.value = await navigator.clipboard.readText();
          renderBtn.click();
        } catch (err) {
          alert('Clipboard error: ' + err);
        }
      });

      renderBtn.addEventListener('click', () => {
        const raw   = mdInput.value;
        const html  = preprocessMath(raw);
        openInNewTab(html, raw);
      });
    });

    // 1) Extract math → placeholder → marked → restore math
    function preprocessMath(source) {
      let idx = 0;
      const slots = [];
      function replace(rx, type, open, close) {
        source = source.replace(rx, (m, c) => {
          if (!c.trim()) return m;
          const key = `%%${type}_${idx}%%`;
          slots.push({ key, open, close, content: c });
          idx++;
          return key;
        });
      }
      // display
      replace(/\$\$([\s\S]+?)\$\$/g,    'D', '$$', '$$');
      replace(/\\\[([\s\S]+?)\\\]/g,    'D', '\\[', '\\]');
      // inline
      replace(/\$([^\s].*?[^\s])\$/g,   'I', '$', '$');
      replace(/\\\(([\s\S]+?)\\\)/g,    'I', '\\(', '\\)');

      let html = marked.parse(source);
      slots.forEach(s => {
        html = html.replace(new RegExp(s.key,'g'),
          `${s.open}${s.content}${s.close}`);
      });
      return html;
    }

    // 2) Open a new tab & inject the rendered HTML + controls
    function openInNewTab(contentHTML, rawMarkdown) {
      const win = window.open();
      if (!win) return alert('Pop-up blocked');
      const d = win.document;
      d.open();
      d.write(`<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Rendered Markdown</title>
  <link rel="stylesheet" href="${CDN.gitMarkdownCss}">
  <link rel="stylesheet" href="${CDN.katexCss}">
  <script src="${CDN.html2canvas}"><\/script>
  <style>
    /* light/dark via CSS vars */
    :root {
      --bg: #fff; --fg: #000; --link: #0366d6;
      --codebg: #f6f8fa; --border: #e1e4e8;
    }
    .dark {
      --bg: #0d1117; --fg: #c9d1d9;
      --link: #58a6ff; --codebg: #161b22;
      --border: #30363d;
    }
    body {
      margin:0; padding:3rem 2rem;
      background:var(--bg); color:var(--fg);
      font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      transition:background .3s, color .3s;
    }
    a { color:var(--link); }
    pre, code { background:var(--codebg); }
    hr, blockquote, th, td { border-color:var(--border); }
    .markdown-body {
      box-sizing:border-box; max-width:960px;
      margin:auto; padding:1rem;
    }
    /* Control panel */
    #controls {
      position:fixed; top:1rem; right:1rem;
      background:rgba(255,255,255,.9);
      padding:.5rem; border-radius:4px;
      display:flex; gap:.5rem; z-index:1000;
    }
    .dark #controls {
      background:rgba(0,0,0,.7); color:#fff;
    }
    #controls button {
      padding:.3rem .6rem; cursor:pointer;
    }
    #controls span {
      min-width:2.5rem; text-align:center;
      display:inline-block;
    }
  </style>
</head>
<body class="markdown-body">
  <div id="controls">
    <button data-action="toggle">⇳</button>
    <button data-action="decrease">A–</button>
    <span data-action="display">100%</span>
    <button data-action="increase">A+</button>
    <button data-action="reset">⟲</button>
    <button data-action="theme">🌙</button>
    <button data-action="save">💾</button>
    <button data-action="raw">Raw</button>
  </div>
  <div id="content">${contentHTML}</div>
  <pre id="raw" style="display:none;white-space:pre-wrap;">${escapeHTML(rawMarkdown)}</pre>

  <!-- pass config -->
  <script>
    window.__CONFIG = {
      CDN: ${JSON.stringify(CDN)},
      FONT_CFG: ${JSON.stringify(FONT_CFG)},
      THEME_KEY: '${THEME_KEY}'
    };
  <\/script>
  <script src="${CDN.katexJs}"><\/script>
  <script src="${CDN.katexAuto}"><\/script>
  <script>
    (function(){
      const { CDN, FONT_CFG, THEME_KEY } = window.__CONFIG;
      const body   = document.body;
      const panel  = document.getElementById('controls');
      const content= document.getElementById('content');
      const rawEl  = document.getElementById('raw');
      const disp   = panel.querySelector('[data-action=display]');

      // FONT SIZE
      let pct = +localStorage.getItem(FONT_CFG.key) || FONT_CFG.defaultPct;
      function applyFont() {
        body.style.fontSize = (FONT_CFG.basePx * pct/100) + 'px';
        disp.textContent = pct + '%';
        localStorage.setItem(FONT_CFG.key, pct);
      }

      // THEME
      const saved = localStorage.getItem(THEME_KEY) || 'light';
      body.classList.toggle('dark', saved==='dark');

      // PANEL EVENTS
      panel.addEventListener('click', e => {
        const act = e.target.dataset.action;
        if (!act) return;
        switch(act) {
          case 'toggle':
            panel.classList.toggle('collapsed');
            break;
          case 'decrease':
            pct = Math.max(FONT_CFG.minPct, pct - FONT_CFG.stepPct);
            applyFont(); break;
          case 'increase':
            pct = Math.min(FONT_CFG.maxPct, pct + FONT_CFG.stepPct);
            applyFont(); break;
          case 'reset':
            pct = FONT_CFG.defaultPct; applyFont(); break;
          case 'theme':
            const now = body.classList.toggle('dark');
            localStorage.setItem(THEME_KEY, now?'dark':'light');
            break;
          case 'save':
            panel.style.display = 'none';
            html2canvas(body).then(canvas => {
              panel.style.display = '';
              const link = document.createElement('a');
              link.href = canvas.toDataURL('image/png');
              link.download = 'md-render-'+Date.now()+'.png';
              link.click();
            });
            break;
          case 'raw':
            const showingRaw = rawEl.style.display!=='none';
            content.style.display = showingRaw?'':'none';
            rawEl.style.display  = showingRaw?'none':'block';
            e.target.textContent = showingRaw?'Raw':'HTML';
            break;
        }
      });

      // MATH RENDER
      function renderMath(){
        if (typeof renderMathInElement==='function') {
          renderMathInElement(document.body, {
            delimiters: [
              {left:'$$',right:'$$',display:true},
              {left:'\\\\[',right:'\\\\]',display:true},
              {left:'$', right:'$', display:false, throwOnError:false},
              {left:'\\\\(',right:'\\\\)',display:false}
            ],
            throwOnError:false
          });
        }
      }

      document.addEventListener('DOMContentLoaded', () => {
        applyFont();
        renderMath();
      });
    })();
  <\/script>
</body>
</html>`);
      d.close();
    }

    // simple HTML-escape for raw view
    function escapeHTML(s) {
      return s.replace(/[&<>"']/g, c => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[c]));
    }
  </script>
</body>
</html>
